<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ASMaQ – Acute Stroke Management Questionnaire</title>
<style>
  :root{
    --bg:#0f172a;            /* slate-900 */
    --card:#111827cc;        /* gray-900 with alpha */
    --muted:#94a3b8;         /* slate-400 */
    --text:#e5e7eb;          /* gray-200 */
    --brand:#06b6d4;         /* cyan-500 */
    --brand-2:#22d3ee;       /* cyan-400 */
    --accent:#8b5cf6;        /* violet-500 */
    --danger:#ef4444;        /* red-500 */
    --ok:#22c55e;            /* green-500 */
    --border:#1f2937;        /* gray-800 */
    --chip:#0ea5e9;          /* sky-500 */
    --shadow: 0 10px 25px rgba(0,0,0,.25);
  }
  html,body{height:100%}
  body{
    margin:0; background:
    radial-gradient(1200px 600px at 100% 0%, #0b1028 0%, #0f172a 40%, #0b1028 100%),
    linear-gradient(135deg, #0b1028 0%, #0f172a 60%, #0b1028 100%);
    color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
  }
  header{
    position:sticky; top:0; z-index:10; backdrop-filter: saturate(140%) blur(10px);
    background: linear-gradient(180deg, rgba(17,24,39,.95), rgba(17,24,39,.6));
    border-bottom:1px solid var(--border);
  }
  .wrap{max-width:1100px; margin:0 auto; padding:18px 16px}
  .brand{
    display:flex; align-items:center; gap:12px;
  }
  .logo{
    width:38px; height:38px; border-radius:50%;
    background: conic-gradient(from 180deg, var(--brand), var(--accent), var(--brand-2), var(--brand));
    box-shadow: inset 0 0 12px #0006, 0 0 18px #0ea5e955;
  }
  h1{font-size:1.25rem; margin:0}
  .tag{color:var(--muted); font-size:.9rem}
  nav{margin-left:auto; display:flex; gap:10px; align-items:center}
  .btn{
    appearance:none; border:1px solid var(--border); color:var(--text);
    background:linear-gradient(180deg,#0b1224,#0b1328);
    padding:10px 14px; border-radius:10px; cursor:pointer; transition:.2s transform, .2s border-color, .2s box-shadow;
  }
  .btn:hover{transform: translateY(-1px); border-color:#1f3a5b; box-shadow:0 8px 18px rgba(2,132,199,.18)}
  .btn.primary{border-color:#0ea5e955; background:linear-gradient(180deg,#0ea5e915,#06b6d415); color:#e6fbff}
  .btn.danger{border-color:#7f1d1d; background:linear-gradient(180deg,#7f1d1d33,#991b1b33); color:#fecaca}
  .btn.success{border-color:#065f46; background:linear-gradient(180deg,#065f4633,#04785733); color:#bbf7d0}
  .grid{
    display:grid; grid-template-columns: 1fr; gap:18px; margin:26px 0;
  }
  .card{
    background: linear-gradient(180deg, rgba(2,6,23,.6), rgba(2,6,23,.4));
    border:1px solid var(--border); border-radius:16px; box-shadow: var(--shadow);
    padding:18px;
  }
  .section-title{
    display:flex; align-items:center; gap:10px; margin:6px 0 14px; font-weight:700; letter-spacing:.2px;
  }
  .chip{
    font-size:.8rem; padding:4px 8px; border-radius:999px; background:linear-gradient(180deg,#0ea5e933,#22d3ee22);
    color:#c8f4ff; border:1px solid #155e75;
  }
  .q{
    border-top:1px dashed var(--border); padding-top:12px; margin-top:12px;
  }
  .q p{margin:.2rem 0 .75rem}
  .likert{
    display:flex; flex-wrap:wrap; gap:10px;
  }
  .pill{
    position:relative;
  }
  .pill input{position:absolute; opacity:0; pointer-events:none}
  .pill label{
    display:inline-block; padding:8px 12px; border-radius:999px; border:1px solid var(--border);
    background:linear-gradient(180deg,#0b1224,#0b1328); color:#cbd5e1; cursor:pointer; transition:.15s transform, .15s border-color, .15s box-shadow, .15s background;
    user-select:none;
  }
  .pill input:checked + label{
    border-color:#0ea5e9; color:#ecfeff; background:linear-gradient(180deg,#0ea5e93a,#22d3ee22);
    box-shadow:0 0 0 2px #0ea5e955 inset, 0 0 0 3px #0ea5e933;
  }
  .two-col{display:grid; grid-template-columns: 1fr; gap:16px}
  @media(min-width:860px){ .two-col{grid-template-columns: 1fr 1fr} }
  .footer{
    color:var(--muted); font-size:.9rem; margin-top:20px; text-align:center; padding:22px 0 40px;
  }
  .toolbar{
    display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-start; margin-top:6px;
  }
  .hidden{display:none !important}
  .table-wrap{overflow:auto; max-height:60vh; border:1px solid var(--border); border-radius:12px}
  table{width:100%; border-collapse:collapse; font-size:.95rem; background:#0b1220}
  th,td{border-bottom:1px solid var(--border); padding:10px 12px; text-align:left; vertical-align:top}
  th{position:sticky; top:0; background:#0b1228; z-index:1}
  .badge{display:inline-block; padding:3px 8px; border-radius:999px; background:#0ea5e922; color:#7dd3fc; border:1px solid #0ea5e944; font-size:.75rem}
  /* Modal */
  .modal-backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; z-index:50;
  }
  .modal{
    width:min(420px, 92vw); background:#0b1220; border:1px solid var(--border); border-radius:16px; box-shadow: var(--shadow); padding:18px;
  }
  .modal h3{margin:.2rem 0 1rem}
  .field{display:flex; flex-direction:column; gap:6px; margin:.6rem 0}
  .field input, .field select, .field textarea{
    background:#0a1222; border:1px solid #1f2a44; color:var(--text); border-radius:10px; padding:10px 12px; font-size:1rem; outline: none;
  }
  .hint{color:var(--muted); font-size:.85rem}
  .toast{
    position:fixed; right:16px; bottom:16px; background:#0a1222; border:1px solid #134e4a; color:#a7f3d0;
    padding:12px 14px; border-radius:12px; box-shadow: var(--shadow); z-index:60;
  }
</style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex; align-items:center; gap:14px;">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>ASMaQ · Manejo del ACV</h1>
        <div class="tag">Cuestionario tipo Likert (5 puntos) · Español (CO)</div>
      </div>
    </div>
    <nav>
      <button class="btn" id="btnAdmin">Iniciar sesión Admin</button>
      <button class="btn success hidden" id="btnConsult">Consultar datos</button>
      <button class="btn primary hidden" id="btnExport">Exportar a Excel</button>
      <button class="btn danger hidden" id="btnLogout">Cerrar sesión</button>
    </nav>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <div class="two-col">
      <div>
        <h2 class="section-title">Indicaciones <span class="chip">Tiempo: 6–8 min</span></h2>
        <p class="hint">Marca una opción por pregunta. Si no estás seguro/a, puedes elegir “Neutral”.</p>
      </div>
      <div>
        <div class="field">
          <label for="participantId">Identificador (opcional):</label>
          <input id="participantId" placeholder="Ej.: CC/ID interno, alias, etc." />
        </div>
        <div class="field">
          <label for="role">Rol (opcional):</label>
          <select id="role">
            <option value="">— Selecciona —</option>
            <option>Enfermería</option>
            <option>Médico/a</option>
            <option>Urgencias</option>
            <option>Interno/Residente</option>
            <option>Otro</option>
          </select>
        </div>
      </div>
    </div>
  </section>

  <form id="form" class="grid" novalidate></form>

  <section class="card">
    <div class="toolbar">
      <button type="button" class="btn primary" id="btnSubmit">Enviar respuestas</button>
      <span class="hint" id="saveHint">Los datos se guardan de forma inmediata en la base de datos.</span>
    </div>
  </section>

  <section class="card hidden" id="adminPanel">
    <h2 class="section-title">Panel de administración <span class="chip">Solo administrador</span></h2>
    <div class="toolbar">
      <button class="btn success" id="btnRefresh">Actualizar</button>
      <span class="hint">Puedes filtrar por rango de fechas o texto libre.</span>
    </div>
    <div class="two-col">
      <div class="field">
        <label>Fecha desde:</label>
        <input type="date" id="fromDate" />
      </div>
      <div class="field">
        <label>Fecha hasta:</label>
        <input type="date" id="toDate" />
      </div>
    </div>
    <div class="field">
      <label>Búsqueda (ID participante, rol, texto…):</label>
      <input id="searchBox" placeholder="Escribe para filtrar en vivo" />
    </div>
    <div class="table-wrap">
      <table id="tbl">
        <thead id="tblHead"></thead>
        <tbody id="tblBody"></tbody>
      </table>
    </div>
  </section>

  <div class="footer">© 2025 · ASMaQ · Construido para uso institucional. No compartas credenciales.</div>
</main>

<!-- Modal de login -->
<div class="modal-backdrop hidden" id="loginBackdrop" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
  <div class="modal">
    <h3 id="loginTitle">Acceso de administrador</h3>
    <div class="field">
      <label>Usuario</label>
      <input id="adminUser" autocomplete="username" placeholder="Usuario admin" />
    </div>
    <div class="field">
      <label>Contraseña</label>
      <input id="adminPass" type="password" autocomplete="current-password" placeholder="Contraseña" />
    </div>
    <div class="toolbar" style="justify-content:flex-end;">
      <button class="btn" id="btnCancelLogin">Cancelar</button>
      <button class="btn primary" id="btnDoLogin">Entrar</button>
    </div>
    <p class="hint">Usuario: <strong>Prueba1</strong> · Contraseña: <strong>Prueba1</strong></p>
  </div>
</div>

<div class="toast hidden" id="toast"></div>

<script>
/* ==========================
   Configuración y datos
========================== */
const DB_BASE = "https://strokeasmaq-default-rtdb.firebaseio.com";
const RESP_PATH = "/responses.json"; // escritura/lectura vía REST

// Cuestionario (3 secciones) tomado del CSV entregado
const survey = [
  {
    section: "Conocimiento general sobre el ACV",
    items: [
      "La confusión repentina puede ser señal de un derrame cerebral.",
      "Una baja de azúcar (hipoglucemia) puede parecer un derrame cerebral.",
      "Un derrame cerebral puede dar problemas de visión.",
      "Una persona con derrame cerebral puede sentir adormecimiento en un brazo o una pierna.",
      "La pérdida de equilibrio al caminar puede ser señal de derrame cerebral.",
      "Un derrame cerebral puede hacer que la persona esté menos despierta o alerta.",
      "La Escala de Glasgow (GCS) sirve para medir el nivel de conciencia.",
      "Hay que hacer un examen neurológico completo de inmediato en personas que llegan con síntomas de derrame cerebral.",
      "En un derrame cerebral, la presión alta debe bajarse a valores normales de una vez.",
      "Los profesionales de salud deben recibir capacitaciones frecuentes sobre manejo del derrame cerebral."
    ],
    scale: ["Totalmente de acuerdo","De acuerdo","Neutral","En desacuerdo","Totalmente en desacuerdo"]
  },
  {
    section: "Manejo hiperagudo del ACV",
    items: [
      "El derrame cerebral solo es una urgencia médica dentro de las primeras 4,5 horas de iniciado.",
      "Todo paciente con sospecha de derrame cerebral debe hacerse una tomografía de cerebro de inmediato.",
      "Todo paciente con sospecha de derrame cerebral debe ser remitido al neurólogo de inmediato.",
      "Entre más rápido se dé el tratamiento, mejores son los resultados del paciente con derrame cerebral.",
      "La terapia trombolítica se da por vena para disolver coágulos.",
      "Mi hospital cuenta con tratamiento trombolítico.",
      "Hay que revisar la coagulación antes de dar trombolisis.",
      "Todo paciente con derrame cerebral debe tener un electrocardiograma de 12 derivaciones antes de la trombolisis.",
      "Una hemorragia dentro del cerebro es una contraindicación para dar trombolisis."
    ],
    scale: ["Totalmente de acuerdo","De acuerdo","Neutral","En desacuerdo","Totalmente en desacuerdo"]
  },
  {
    section: "Manejo avanzado del ACV",
    items: [
      { q: "¿Usted es capaz de detectar síntomas de un derrame cerebral?", scale: ["Muy probable","Probable","Neutral","Poco probable","Nada probable"] },
      { q: "¿Conoce la prueba FAST (Cara, Brazo, Habla, Tiempo)?", scale: ["Muy familiar","Familiar","Neutral","Poco familiar","Nunca la he oído"] },
      { q: "¿Cómo califica su conocimiento sobre el manejo del derrame cerebral?", scale: ["Muy bueno","Bueno","Neutral","Malo","Muy malo"] },
      { q: "¿Sabe sobre el tratamiento de trombectomía mecánica para el derrame cerebral?", scale: ["Muy al tanto","Al tanto","Neutral","Poco familiar","Nunca lo he oído"] },
      "La trombectomía mecánica se usa para sacar coágulos en un derrame cerebral.",
      "Mi hospital cuenta con servicio de trombectomía mecánica.",
      "Los síntomas del derrame cerebral se pueden revertir con trombolisis o trombectomía mecánica.",
      "Se puede hacer trombectomía mecánica después de una trombolisis.",
      "La trombolisis y la trombectomía mecánica solo se pueden hacer dentro de una ventana de tiempo específica.",
      "Los derrames cerebrales que se descubren al despertar no son candidatos para trombolisis ni trombectomía mecánica."
    ],
    scale: ["Totalmente de acuerdo","De acuerdo","Neutral","En desacuerdo","Totalmente en desacuerdo"]
  }
];

// Estado
let isAdmin = false;
let cacheData = []; // respuestas traídas para admin

/* ==========================
   Utilidades UI
========================== */
const $ = (id)=>document.getElementById(id);
const show = (el)=>el.classList.remove('hidden');
const hide = (el)=>el.classList.add('hidden');
function toast(msg, ok=true, ms=3200){
  const el = $("toast");
  el.textContent = msg;
  el.style.borderColor = ok ? "#134e4a" : "#7f1d1d";
  el.style.color      = ok ? "#a7f3d0" : "#fecaca";
  show(el);
  setTimeout(()=> hide(el), ms);
}

/* ==========================
   Render del formulario
========================== */
function renderForm(){
  const form = $("form");
  form.innerHTML = "";

  survey.forEach((sec, si)=>{
    const card = document.createElement("section");
    card.className = "card";

    const title = document.createElement("h3");
    title.className = "section-title";
    title.innerHTML = `${sec.section} <span class="chip">Sección ${si+1}/3</span>`;
    card.appendChild(title);

    sec.items.forEach((item, qi)=>{
      const qWrap = document.createElement("div");
      qWrap.className = "q";
      const text = typeof item === "string" ? item : item.q;
      const scale = typeof item === "string" ? sec.scale : item.scale;

      const p = document.createElement("p");
      p.textContent = `${qi+1}. ${text}`;
      qWrap.appendChild(p);

      const likert = document.createElement("div");
      likert.className = "likert";

      scale.forEach((opt, oi)=>{
        const name = `s${si}_q${qi}`;
        const id = `${name}_o${oi}`;
        const pill = document.createElement("div");
        pill.className = "pill";
        const input = document.createElement("input");
        input.type="radio"; input.name=name; input.id=id; input.value=opt; input.required = true;
        const label = document.createElement("label");
        label.setAttribute("for", id); label.textContent = opt;
        pill.appendChild(input); pill.appendChild(label);
        likert.appendChild(pill);
      });

      qWrap.appendChild(likert);
      card.appendChild(qWrap);
    });

    form.appendChild(card);
  });
}

/* ==========================
   Recolección y envío
========================== */
function collectAnswers(){
  const data = {
    timestamp: new Date().toISOString(),
    participantId: $("participantId").value.trim() || null,
    role: $("role").value || null,
    responses: []
  };

  survey.forEach((sec, si)=>{
    const block = { section: sec.section, items: [] };
    sec.items.forEach((item, qi)=>{
      const name = `s${si}_q${qi}`;
      const sel = document.querySelector(`input[name="${name}"]:checked`);
      const qText = typeof item === "string" ? item : item.q;
      const scale = typeof item === "string" ? sec.scale : item.scale;
      block.items.push({
        question: qText,
        answer: sel ? sel.value : null,
        scale
      });
    });
    data.responses.push(block);
  });

  // Validación simple
  const totalQs = survey.reduce((n, sec)=> n + sec.items.length, 0);
  const marked = data.responses.reduce((n, sec)=> n + sec.items.filter(i=>!!i.answer).length, 0);
  if(marked < totalQs){
    throw new Error(`Te faltan ${totalQs - marked} respuestas por marcar.`);
  }
  return data;
}

async function sendToDB(payload){
  // POST a /responses.json crea un nuevo nodo con key única
  const res = await fetch(DB_BASE + RESP_PATH, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  if(!res.ok){
    const t = await res.text().catch(()=> "");
    throw new Error("No se pudo guardar en la base de datos. " + t);
  }
  return res.json();
}

/* ==========================
   Administración
========================== */
function setAdminUI(state){
  isAdmin = state;
  localStorage.setItem("ASMAQ_ADMIN", state ? "1":"0");
  // botones
  if(isAdmin){
    hide($("btnAdmin"));
    show($("btnConsult"));
    show($("btnExport"));
    show($("btnLogout"));
    show($("adminPanel"));
  }else{
    show($("btnAdmin"));
    hide($("btnConsult"));
    hide($("btnExport"));
    hide($("btnLogout"));
    hide($("adminPanel"));
  }
}

function checkPersistedAdmin(){
  const p = localStorage.getItem("ASMAQ_ADMIN")==="1";
  setAdminUI(p);
}

function openLogin(){ show($("loginBackdrop")); $("adminUser").focus(); }
function closeLogin(){ hide($("loginBackdrop")); }

function doLogin(){
  const u = $("adminUser").value.trim();
  const p = $("adminPass").value.trim();
  if(u==="Prueba1" && p==="Prueba1"){
    setAdminUI(true);
    $("adminUser").value = ""; $("adminPass").value = "";
    closeLogin();
    toast("Inicio de sesión exitoso. Bienvenido/a.", true);
  }else{
    toast("Usuario o contraseña inválidos.", false);
  }
}

async function fetchAll(){
  const res = await fetch(DB_BASE + RESP_PATH, { method:"GET" });
  if(!res.ok){
    const t = await res.text().catch(()=> "");
    throw new Error("No se pudo consultar la base de datos. " + t);
  }
  const obj = await res.json() || {};
  // Normalizar a arreglo
  const arr = Object.entries(obj).map(([id, val])=>({ _id:id, ...val }));
  cacheData = arr.sort((a,b)=> (a.timestamp||"").localeCompare(b.timestamp||""));
  return cacheData;
}

function withinDate(ts, from, to){
  if(!ts) return false;
  const d = new Date(ts);
  if(from && d < new Date(from)) return false;
  if(to   && d > new Date(to + "T23:59:59")) return false;
  return true;
}

function filterData(){
  const q = $("searchBox").value.toLowerCase().trim();
  const from = $("fromDate").value;
  const to   = $("toDate").value;
  return cacheData.filter(r=>{
    if(!withinDate(r.timestamp, from, to)) return false;
    const blob = [
      r._id, r.timestamp, r.participantId, r.role,
      ...r.responses.flatMap(sec=> [sec.section, ...sec.items.map(it=> `${it.question} ${it.answer}`)])
    ].join(" ").toLowerCase();
    return q ? blob.includes(q) : true;
  });
}

function renderTable(rows){
  const head = $("tblHead"), body = $("tblBody");
  head.innerHTML = ""; body.innerHTML = "";
  if(rows.length===0){
    head.innerHTML = "<tr><th>No hay datos</th></tr>";
    return;
  }

  // Construir cabeceras dinámicas: meta + cada pregunta como columna
  const metaCols = ["_id","timestamp","participantId","role"];
  const questions = [];
  // Tomar preguntas de la estructura original (ordena y fija columnas)
  survey.forEach(sec=>{
    sec.items.forEach(it=>{
      const qText = typeof it === "string" ? it : it.q;
      questions.push(qText);
    });
  });
  const allCols = [...metaCols, ...questions];

  // Render head
  const trh = document.createElement("tr");
  allCols.forEach(c=>{
    const th = document.createElement("th");
    th.textContent = c.length>60 ? c.slice(0,57)+"…" : c;
    th.title = c;
    trh.appendChild(th);
  });
  head.appendChild(trh);

  // Render body
  rows.forEach(r=>{
    const tr = document.createElement("tr");
    const answersMap = new Map();
    (r.responses||[]).forEach(sec=>{
      (sec.items||[]).forEach(it=>{
        answersMap.set(it.question, it.answer ?? "");
      });
    });
    allCols.forEach(c=>{
      const td = document.createElement("td");
      let val = "";
      if(c==="_id") val = r._id;
      else if(c==="timestamp") val = r.timestamp ? new Date(r.timestamp).toLocaleString() : "";
      else if(c==="participantId") val = r.participantId ?? "";
      else if(c==="role") val = r.role ?? "";
      else val = answersMap.get(c) ?? "";
      td.textContent = val;
      tr.appendChild(td);
    });
    body.appendChild(tr);
  });
}

function exportCSV(rows){
  if(rows.length===0){ toast("No hay datos para exportar.", false); return; }
  // Cabeceras mismas que en renderTable
  const headers = ["_id","timestamp","participantId","role"];
  survey.forEach(sec=>{
    sec.items.forEach(it=>{
      const qText = typeof it === "string" ? it : it.q;
      headers.push(qText);
    });
  });

  const lines = [];
  // Encabezados CSV (entre comillas para Excel)
  lines.push(headers.map(h=> `"${h.replace(/"/g,'""')}"`).join(","));

  rows.forEach(r=>{
    const map = new Map();
    (r.responses||[]).forEach(sec=>{
      (sec.items||[]).forEach(it=> map.set(it.question, it.answer ?? ""));
    });
    const row = headers.map(h=>{
      let v = "";
      if(h==="_id") v = r._id;
      else if(h==="timestamp") v = r.timestamp;
      else if(h==="participantId") v = r.participantId ?? "";
      else if(h==="role") v = r.role ?? "";
      else v = map.get(h) ?? "";
      // CSV escapado
      v = (v??"").toString().replace(/"/g,'""');
      return `"${v}"`;
    }).join(",");
    lines.push(row);
  });

  const blob = new Blob([lines.join("\r\n")], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  const dt = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  a.download = `ASMaQ_export_${dt}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ==========================
   Eventos
========================== */
window.addEventListener("DOMContentLoaded", ()=>{
  renderForm();
  checkPersistedAdmin();

  $("btnSubmit").addEventListener("click", async ()=>{
    try{
      const payload = collectAnswers();
      // Guardado
      await sendToDB(payload);
      toast("¡Respuestas enviadas con éxito! Gracias 🙌", true);
      // Reiniciar selección
      document.querySelectorAll('input[type="radio"]:checked').forEach(inp=> inp.checked=false);
    }catch(err){
      toast(err.message || "Error al enviar.", false);
    }
  });

  // Admin UI
  $("btnAdmin").addEventListener("click", openLogin);
  $("btnCancelLogin").addEventListener("click", closeLogin);
  $("btnDoLogin").addEventListener("click", doLogin);
  $("btnLogout").addEventListener("click", ()=>{
    setAdminUI(false);
    toast("Sesión cerrada.");
  });

  $("btnConsult").addEventListener("click", async ()=>{
    try{
      await fetchAll();
      renderTable(filterData());
      toast("Datos cargados.");
      window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
    }catch(err){
      toast(err.message || "Error consultando datos.", false);
    }
  });

  $("btnRefresh").addEventListener("click", async ()=>{
    try{
      await fetchAll();
      renderTable(filterData());
      toast("Datos actualizados.");
    }catch(err){
      toast(err.message || "Error actualizando.", false);
    }
  });

  ["fromDate","toDate","searchBox"].forEach(id=>{
    $(id).addEventListener("input", ()=> renderTable(filterData()));
  });

  $("btnExport").addEventListener("click", ()=>{
    if(!isAdmin){ toast("Solo el administrador puede exportar.", false); return; }
    const rows = filterData();
    exportCSV(rows);
  });

});
</script>
</body>
</html>
